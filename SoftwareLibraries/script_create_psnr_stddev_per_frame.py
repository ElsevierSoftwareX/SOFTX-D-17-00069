
#Source, Resolution, Src, Metric, HRC, Avg, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250
#src01_1280x720p25.yuv,1280x720,src01,psnr000,GOP2_1000000_1_16_64_8_0,41.135275,42.897213,41.814648,41.533897,42.278347,41.806984,42.437126,42.354424,42.628613,42.572269,42.838192,42.765453,42.980309,42.926994,43.136463,43.069809,44.302559,43.035969,42.992142,42.891312,43.136475,43.147873,43.246628,43.227272,43.320633,43.248474,43.313793,43.286671,43.307541,43.273300,43.283764,43.328865,44.251976,42.975269,42.578995,42.525436,42.546928,42.556160,42.495792,42.378204,42.515442,42.509808,42.571095,42.555912,42.611961,42.584789,42.690758,42.732254,43.895420,43.033466,42.517162,42.391178,42.544678,42.500381,42.521606,42.507835,42.407555,42.431339,42.083542,42.240204,41.802845,41.726162,41.364746,41.431137,42.704254,43.105965,41.850857,41.632278,41.513557,41.547661,41.177097,41.004044,40.764420,40.782440,40.673798,40.648666,41.038860,41.047691,41.241413,41.286888,43.223980,43.153244,42.256390,42.097965,42.030052,42.001469,41.891792,41.906944,41.901218,41.883808,41.944206,41.959740,42.042366,41.919228,42.034950,42.033337,43.610912,43.176357,42.345634,42.244797,42.272377,42.238064,42.097824,42.113937,42.106560,42.152637,42.146072,42.147896,42.211788,42.190628,42.215530,42.260777,43.643177,43.212265,42.440083,42.286156,42.092381,42.119453,41.924290,41.886925,41.906746,41.887897,41.912178,41.934277,42.003864,41.952759,42.006462,42.000061,43.593830,43.177517,42.422886,42.213142,42.177189,42.233604,41.852242,41.861450,41.567188,41.620644,41.204525,41.168343,40.926048,40.885769,40.888969,40.689392,42.948853,43.149094,42.077957,41.908134,41.696609,41.737701,41.701248,41.629559,41.475113,41.613163,41.430069,41.394913,41.409580,41.406746,41.564926,41.557026,43.105984,42.785912,41.882137,41.724155,41.560116,41.590359,41.332077,41.379917,41.378429,41.316963,41.381500,41.269722,41.367558,41.356403,41.368675,41.367935,42.969852,42.830734,41.335136,41.437126,40.926731,40.863266,40.521812,40.493130,40.232769,40.222664,40.238289,40.041851,40.633121,40.660477,40.898903,40.955612,42.858475,42.659542,41.749737,41.727856,41.663105,41.634823,41.510334,41.417961,41.244873,41.146568,40.722694,40.737072,40.150444,40.177055,39.879894,39.798531,41.619385,40.988571,40.650661,40.446114,40.774673,40.783978,40.844414,40.788322,40.891491,40.883816,40.830143,40.877872,40.814167,40.829079,40.834091,40.862190,41.246078,38.843548,38.624672,38.591412,38.091721,38.049351,37.029263,37.122936,35.845978,35.835976,34.230869,34.036587,33.093304,32.598728,32.498039,32.012562,35.562092,33.602325,33.208485,32.993801,32.118668,32.077011,31.540792,31.177629,31.068314,30.787800,30.614622
#...

import sys
import math

frame_num=250

def read_data(fname, metric, isHeaderPresent=False):
	data={}
	f=open(fname,"r")
	if isHeaderPresent:
		line_header=f.readline()
	else:
		line_header=""
	line=f.readline()
	while line:
		if metric in line:
			v=line.split(',')
			sourceyuv=v[0]
			resolution=v[1]
			src=v[2]
			metric=v[3]
			hrc=v[4]
			#avg=float(v[5])  # Note this removes the trailing \n

			list_val=[]
			list_contains_infinite_values=False
			for i in range(frame_num):
				try:
					# +6  (element [5] is the average of the remaining ones)
					val=float(v[i+6]) # float automatically removes trailing \n on the last element
				except ValueError:
					# Note that float does not handle the "1.#INF00" constant, it has to be handled manually
					#print v[i+6]
					#sys.exit()
					val='1.#INF00'
					list_contains_infinite_values=True
				list_val.append(val)

			#key= "%s,%s,%s" % (resolution,src,hrc)
			key= "%s,%s,%s,%s" % (sourceyuv,resolution,src,hrc)
			data[key]={'list':list_val,'infinite_values':list_contains_infinite_values}

		line=f.readline()
	f.close()
	return line_header,data


def variance(lis):
	tot=0.0
	totsq=0.0	
	n=len(lis)
	for i in range(n):
		v=lis[i]
		tot+=v
		totsq+=(v*v)
	var=( totsq - (tot*tot)/n ) / (n-1)
	return var


###############################
# main
###############################

if len(sys.argv)!=4:
	print >> sys.stderr, "Usage: %s fname.csv fname_mse.csv fileout_stddev.csv" % (sys.argv[0])
	print >> sys.stderr
	sys.exit(1)
	
fname=sys.argv[1]
fname_mse=sys.argv[2]
foutname=sys.argv[3]

line_header,data_metricIDpsnr=read_data(fname, "psnr000")
#print line_header
#print "Source, Resolution, Src, Metric, HRC, Avg"
print "READ source file %s" % (fname)
line_header2,data_metricIDmse=read_data(fname_mse, "mse_000")
print "READ source file %s" % (fname_mse)


fout=open(foutname, "w")
fout.write("#Source, Resolution, Src, Metric, HRC, avgpsnr, psnrmse, mean_psnr, stddev_psnr, mean_mse, stddev_mse\n")

cnt=0
for k in data_metricIDpsnr:
	list_psnr = data_metricIDpsnr[k]['list']
	list_mse = data_metricIDmse[k]['list']
	list_contains_infinite_values = data_metricIDpsnr[k]['infinite_values']

	if cnt%1000==0:
		print "%d " % (cnt),  # no \n : show progress
		sys.stdout.flush()

	if not list_contains_infinite_values:

		_psnr=[]
		_mse=[]
		_psnr=list_psnr[:]
		_mse=list_mse[:]

		avgpsnr=sum(list_psnr)/float(len(list_psnr))
		avgmse=sum(list_mse)/float(len(list_mse))
		psnrmse= 10.0*math.log10(255.0*255.0/avgmse)  # Compute PSNR from the avg of the MSE

		mean_psnr=sum(_psnr)/float(len(_psnr))
		stddev_psnr=math.sqrt(variance(_psnr))
		mean_mse=sum(_mse)/float(len(_mse))
		stddev_mse=math.sqrt(variance(_mse))

		k_split=k.split(',')
		k_source_resolution_src=','.join( k_split[0:3] )
		k_hrc=k_split[3]
		fout.write("%s,%s,%s,%.6f,%.6f,%.6f,%.6f,%.6f,%.6f\n" % (k_source_resolution_src,"psnr000_psnrA00",k_hrc,avgpsnr,psnrmse, mean_psnr, stddev_psnr, mean_mse, stddev_mse) )

	cnt+=1

fout.close()

